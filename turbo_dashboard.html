<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 TURBO TRANSFER COMMAND CENTER | CIS Intelligence Dashboard</title>
    
    <!-- Bootstrap 4.6 + Custom Styling -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
    
    <style>
        /* 🎨 TURBO DASHBOARD STYLING */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #17a2b8;
            --dark-color: #1a1a1a;
            --gradient-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --shadow-dark: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        body {
            background: var(--gradient-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        
                .dashboard-container {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
            padding: 30px;
            width: 100%;
        }
        
        .dashboard-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .dashboard-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .dashboard-header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-top: 10px;
        }
        
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .control-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            border-left: 5px solid var(--secondary-color);
        }
        
        .control-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }
        
        .control-card h3 {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .control-card h3 i {
            margin-right: 12px;
            font-size: 1.3em;
            color: var(--secondary-color);
        }
        
        .btn-turbo {
            background: linear-gradient(45deg, var(--secondary-color), #2980b9);
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-turbo:hover {
            background: linear-gradient(45deg, #2980b9, var(--secondary-color));
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
            color: white;
        }
        
        .btn-success-turbo {
            background: linear-gradient(45deg, var(--success-color), #229954);
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }
        
        .btn-success-turbo:hover {
            background: linear-gradient(45deg, #229954, var(--success-color));
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
            color: white;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .metric-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-color);
            display: block;
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 8px;
        }
        
        .metric-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            opacity: 0.7;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online { background-color: var(--success-color); }
        .status-warning { background-color: var(--warning-color); }
        .status-offline { background-color: var(--danger-color); }
        
        .recommendations-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .recommendation-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid var(--info-color);
            transition: all 0.3s ease;
        }
        
        .recommendation-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .priority-high { border-left-color: var(--danger-color); }
        .priority-medium { border-left-color: var(--warning-color); }
        .priority-low { border-left-color: var(--success-color); }
        
        .route-map {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            min-height: 400px;
        }
        
        .decision-log {
            background: var(--dark-color);
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            padding: 20px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
        }
        
        .progress-enhanced {
            height: 8px;
            border-radius: 4px;
            background: #e9ecef;
            overflow: hidden;
        }
        
        .progress-bar-enhanced {
            height: 100%;
            background: linear-gradient(45deg, var(--success-color), #2ecc71);
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .confidence-meter {
            position: relative;
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            border-radius: 10px;
            transition: all 0.5s ease;
            background: linear-gradient(90deg, var(--danger-color) 0%, var(--warning-color) 50%, var(--success-color) 100%);
        }
        
        .debug-panel {
            background: #1e1e1e;
            color: #ffffff;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .influence-factor {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .influence-factor:last-child {
            border-bottom: none;
        }
        
        .factor-bar {
            width: 60%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .factor-fill {
            height: 100%;
            background: linear-gradient(45deg, var(--secondary-color), var(--info-color));
            border-radius: 3px;
            transition: all 0.3s ease;
        }
        
        @media (max-width: 768px) {
            .dashboard-container {
                margin: 10px;
                padding: 20px;
            }
            
            .control-panel {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .dashboard-header h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>

<!-- CIS STANDARD CONTAINER STRUCTURE -->
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="dashboard-container">
                <!-- 🚀 DASHBOARD HEADER -->
                <div class="dashboard-header">
                    <h1><i class="fas fa-rocket"></i> TURBO TRANSFER COMMAND CENTER</h1>
                    <div class="subtitle">
                        AI-Powered Stock Intelligence | Real-Time Network Optimization | Route Planning Engine
                    </div>
            
            <!-- 🔗 QUICK ACCESS LINKS -->
            <div class="mt-3 mb-2">
                <a href="https://staff.vapeshed.co.nz/assets/cron/NewTransferV3/turbo_dashboard.html" class="btn btn-sm btn-outline-light mr-2" target="_blank" title="Main Dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="https://staff.vapeshed.co.nz/assets/cron/NewTransferV3/turbo_debugger.php" class="btn btn-sm btn-outline-light mr-2" target="_blank" title="Debug Interface">
                    <i class="fas fa-bug"></i> Debugger
                </a>
                <a href="https://staff.vapeshed.co.nz/assets/cron/NewTransferV3/turbo_api.php" class="btn btn-sm btn-outline-light mr-2" target="_blank" title="API Endpoint">
                    <i class="fas fa-code"></i> API
                </a>
                <a href="https://staff.vapeshed.co.nz/assets/cron/NewTransferV3/TURBO_IMPLEMENTATION_GUIDE.md" class="btn btn-sm btn-outline-light mr-2" target="_blank" title="Complete Documentation">
                    <i class="fas fa-book"></i> Docs
                </a>
                <a href="https://staff.vapeshed.co.nz/assets/cron/NewTransferV3/TurboAutonomousTransferEngine.php" class="btn btn-sm btn-outline-light" target="_blank" title="Core AI Engine">
                    <i class="fas fa-brain"></i> Engine
                </a>
            </div>
            
            <div class="mt-3">
                <span class="status-indicator status-online"></span> System Status: ONLINE
                <span class="ml-4"><i class="fas fa-clock"></i> Last Update: <span id="lastUpdate">--:--:--</span></span>
                <span class="ml-4"><i class="fas fa-brain"></i> AI Confidence: <span id="aiConfidence">---%</span></span>
            </div>
        </div>

        <!-- 📊 REAL-TIME METRICS -->
        <div class="metrics-grid" id="metricsGrid">
            <div class="metric-card pulse-animation">
                <div class="metric-icon"><i class="fas fa-exchange-alt text-primary"></i></div>
                <span class="metric-value" id="activeTransfers">0</span>
                <div class="metric-label">Active Transfers</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon"><i class="fas fa-dollar-sign text-success"></i></div>
                <span class="metric-value" id="totalValue">$0</span>
                <div class="metric-label">Total Value</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon"><i class="fas fa-shipping-fast text-info"></i></div>
                <span class="metric-value" id="shippingCost">$0</span>
                <div class="metric-label">Shipping Costs</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon"><i class="fas fa-chart-line text-warning"></i></div>
                <span class="metric-value" id="profitMargin">0%</span>
                <div class="metric-label">Profit Margin</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon"><i class="fas fa-weight-hanging text-secondary"></i></div>
                <span class="metric-value" id="totalWeight">0kg</span>
                <div class="metric-label">Total Weight</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon"><i class="fas fa-route text-danger"></i></div>
                <span class="metric-value" id="totalDistance">0km</span>
                <div class="metric-label">Route Distance</div>
            </div>
        </div>

        <!-- 🎛️ CONTROL PANEL -->
        <div class="control-panel">
            <!-- AI Analysis Controls -->
            <div class="control-card">
                <h3><i class="fas fa-brain"></i> AI Transfer Analysis</h3>
                <div class="mb-3">
                    <label>Analysis Mode:</label>
                    <select class="form-control" id="analysisMode">
                        <option value="full_network">Full Network Scan</option>
                        <option value="critical_only">Critical Items Only</option>
                        <option value="high_value">High Value Focus</option>
                        <option value="cost_optimized">Cost Optimized</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label>Confidence Threshold:</label>
                    <input type="range" class="form-control-range" id="confidenceThreshold" min="50" max="95" value="75">
                    <small>Current: <span id="confidenceValue">75%</span></small>
                </div>
                <button class="btn btn-turbo btn-block" onclick="runAnalysis()">
                    <i class="fas fa-play"></i> Run Analysis
                </button>
            </div>

            <!-- Route Optimization -->
            <div class="control-card">
                <h3><i class="fas fa-route"></i> Route Optimization</h3>
                <div class="mb-3">
                    <label>Optimization Strategy:</label>
                    <select class="form-control" id="routeStrategy">
                        <option value="distance">Minimize Distance</option>
                        <option value="time">Minimize Time</option>
                        <option value="cost">Minimize Fuel Cost</option>
                        <option value="efficiency">Maximum Efficiency</option>
                    </select>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="avoidTraffic" checked>
                        <label class="form-check-label" for="avoidTraffic">Avoid Traffic Hours</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="multipleDeliveries" checked>
                        <label class="form-check-label" for="multipleDeliveries">Combine Multiple Deliveries</label>
                    </div>
                </div>
                <button class="btn btn-success-turbo btn-block" onclick="optimizeRoutes()">
                    <i class="fas fa-map-marked-alt"></i> Optimize Routes
                </button>
            </div>

            <!-- Cost Analysis -->
            <div class="control-card">
                <h3><i class="fas fa-calculator"></i> Cost Analysis</h3>
                <div class="mb-3">
                    <label>Max Shipping Cost %:</label>
                    <input type="range" class="form-control-range" id="maxShippingCost" min="5" max="25" value="15">
                    <small>Current: <span id="shippingCostValue">15%</span></small>
                </div>
                <div class="mb-3">
                    <label>Min ROI %:</label>
                    <input type="range" class="form-control-range" id="minROI" min="10" max="50" value="15">
                    <small>Current: <span id="roiValue">15%</span></small>
                </div>
                <button class="btn btn-turbo btn-block" onclick="analyzeCosts()">
                    <i class="fas fa-chart-pie"></i> Analyze Costs
                </button>
            </div>

            <!-- System Monitoring -->
            <div class="control-card">
                <h3><i class="fas fa-heartbeat"></i> System Monitoring</h3>
                <div class="mb-3">
                    <strong>AI Influence Factors:</strong>
                    <div id="influenceFactors" class="mt-2">
                        <!-- Dynamic influence factors will be loaded here -->
                    </div>
                </div>
                <div class="mb-3">
                    <strong>System Health:</strong>
                    <div class="progress-enhanced mt-2">
                        <div class="progress-bar-enhanced" id="systemHealth" style="width: 95%"></div>
                    </div>
                    <small class="text-muted">95% - Excellent</small>
                </div>
                <button class="btn btn-turbo btn-block" onclick="toggleDebugMode()">
                    <i class="fas fa-bug"></i> <span id="debugToggleText">Enable Debug Mode</span>
                </button>
            </div>
        </div>

        <!-- 🗺️ ROUTE MAP -->
        <div class="route-map">
            <h3><i class="fas fa-map"></i> Delivery Route Map</h3>
            <div id="routeMap" style="height: 350px; border-radius: 10px;"></div>
        </div>

        <!-- 📋 RECOMMENDATIONS PANEL -->
        <div class="recommendations-container">
            <h3><i class="fas fa-list-ul"></i> AI Transfer Recommendations</h3>
            <div id="recommendationsContainer">
                <div class="text-center text-muted py-4">
                    <i class="fas fa-brain fa-3x mb-3"></i>
                    <p>Click "Run Analysis" to generate AI-powered transfer recommendations</p>
                </div>
            </div>
        </div>

        <!-- 🔍 DEBUG & DECISION LOG -->
        <div class="control-card" id="debugPanel" style="display: none;">
            <h3><i class="fas fa-microscope"></i> Decision Transparency & Debug Log</h3>
            <div class="mb-3">
                <strong>Real-Time Decision Log:</strong>
                <div class="decision-log" id="decisionLog">
                    [SYSTEM] Waiting for analysis to begin...
                </div>
            </div>
            <div class="mb-3">
                <strong>Confidence Breakdown:</strong>
                <div class="confidence-meter">
                    <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
                </div>
                <small class="text-muted">Overall System Confidence: <span id="overallConfidence">0%</span></small>
            </div>
            <button class="btn btn-sm btn-turbo" onclick="exportDebugLog()">
                <i class="fas fa-download"></i> Export Debug Log
            </button>
        </div>
    </div>

    <!-- 🎉 TOAST NOTIFICATIONS -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        /**
         * 🚀 TURBO TRANSFER DASHBOARD - JAVASCRIPT CONTROL SYSTEM
         * Real-time AI analysis, route optimization, and decision transparency
         */

        let map = null;
        let isDebugMode = false;
        let analysisInProgress = false;
        let decisionLogEntries = [];
        let currentRecommendations = [];
        let systemMetrics = {
            activeTransfers: 0,
            totalValue: 0,
            shippingCost: 0,
            profitMargin: 0,
            totalWeight: 0,
            totalDistance: 0
        };

        // Initialize Dashboard
        $(document).ready(function() {
            initializeDashboard();
            initializeMap();
            startRealTimeUpdates();
            setupEventHandlers();
            
            showToast('Dashboard initialized successfully!', 'success');
            logDecision('DASHBOARD_INIT', 'Turbo Transfer Dashboard loaded and ready');
        });

        /**
         * 🏁 INITIALIZE DASHBOARD COMPONENTS
         */
        function initializeDashboard() {
            updateLastUpdateTime();
            loadInfluenceFactors();
            updateSystemHealth();
            
            // Set initial confidence threshold display
            updateConfidenceDisplay();
            updateShippingCostDisplay();
            updateROIDisplay();
        }

        /**
         * 🗺️ INITIALIZE ROUTE MAP
         */
        function initializeMap() {
            // Initialize Leaflet map centered on New Zealand
            map = L.map('routeMap').setView([-41.2865, 174.7762], 6); // Wellington, NZ
            
            // Add OpenStreetMap tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add sample store markers
            addSampleStoreMarkers();
        }

        /**
         * 🏪 ADD SAMPLE STORE MARKERS TO MAP
         */
        function addSampleStoreMarkers() {
            const sampleStores = [
                { name: 'Auckland Central', lat: -36.8485, lng: 174.7633, type: 'source' },
                { name: 'Wellington Hub', lat: -41.2865, lng: 174.7762, type: 'warehouse' },
                { name: 'Christchurch Store', lat: -43.5321, lng: 172.6362, type: 'target' },
                { name: 'Hamilton Branch', lat: -37.7870, lng: 175.2793, type: 'target' },
                { name: 'Tauranga Outlet', lat: -37.6878, lng: 176.1651, type: 'target' }
            ];

            sampleStores.forEach(store => {
                const icon = store.type === 'warehouse' ? '🏭' : 
                           store.type === 'source' ? '📦' : '🏪';
                
                const marker = L.marker([store.lat, store.lng]).addTo(map);
                marker.bindPopup(`${icon} <strong>${store.name}</strong><br>Type: ${store.type}`);
            });
        }

        /**
         * ⚡ START REAL-TIME UPDATES
         */
        function startRealTimeUpdates() {
            // Update metrics every 30 seconds
            setInterval(() => {
                if (!analysisInProgress) {
                    updateLastUpdateTime();
                    updateSystemHealth();
                }
            }, 30000);
            
            // Update influence factors every 5 seconds during analysis
            setInterval(() => {
                if (analysisInProgress) {
                    updateInfluenceFactors();
                }
            }, 5000);
        }

        /**
         * 🎛️ SETUP EVENT HANDLERS
         */
        function setupEventHandlers() {
            // Confidence threshold slider
            $('#confidenceThreshold').on('input', updateConfidenceDisplay);
            
            // Shipping cost slider  
            $('#maxShippingCost').on('input', updateShippingCostDisplay);
            
            // ROI slider
            $('#minROI').on('input', updateROIDisplay);
        }

        /**
         * 🧠 RUN AI ANALYSIS
         */
        async function runAnalysis() {
            if (analysisInProgress) {
                showToast('Analysis already in progress!', 'warning');
                return;
            }

            analysisInProgress = true;
            const analysisMode = $('#analysisMode').val();
            const confidenceThreshold = parseInt($('#confidenceThreshold').val());

            // Update UI to show analysis in progress
            $('.btn-turbo').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Analyzing...');
            
            logDecision('ANALYSIS_START', `Starting ${analysisMode} analysis with ${confidenceThreshold}% confidence threshold`);
            
            showToast('🧠 AI Analysis started...', 'info');

            try {
                // Simulate analysis steps with progress updates
                await simulateAnalysisProgress();
                
                // Call backend API
                const response = await $.ajax({
                    url: 'TurboAutonomousTransferEngine.php',
                    method: 'POST',
                    dataType: 'json',
                    data: {
                        action: 'run_analysis',
                        mode: analysisMode,
                        confidence_threshold: confidenceThreshold / 100,
                        debug: isDebugMode
                    }
                });

                if (response.success) {
                    currentRecommendations = response.recommendations;
                    displayRecommendations(response.recommendations);
                    updateMetrics(response.summary);
                    updateRouteMap(response.recommendations);
                    
                    if (isDebugMode) {
                        displayDecisionLog(response.decision_log);
                    }
                    
                    showToast(`✅ Analysis complete! ${response.recommendations.length} recommendations generated.`, 'success');
                    logDecision('ANALYSIS_COMPLETE', `Generated ${response.recommendations.length} recommendations`);
                } else {
                    throw new Error(response.error || 'Analysis failed');
                }
                
            } catch (error) {
                console.error('Analysis error:', error);
                showToast('❌ Analysis failed: ' + error.message, 'error');
                logDecision('ANALYSIS_ERROR', `Analysis failed: ${error.message}`);
            } finally {
                analysisInProgress = false;
                $('.btn-turbo').prop('disabled', false).html('<i class="fas fa-play"></i> Run Analysis');
            }
        }

        /**
         * 📊 SIMULATE ANALYSIS PROGRESS
         */
        async function simulateAnalysisProgress() {
            const steps = [
                'Scanning network inventory...',
                'Analyzing stock imbalances...',
                'Calculating shipping costs...',
                'Optimizing pack compliance...',
                'Evaluating route efficiency...',
                'Generating recommendations...'
            ];

            for (let i = 0; i < steps.length; i++) {
                logDecision('ANALYSIS_STEP', steps[i]);
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // Update progress
                const progress = ((i + 1) / steps.length) * 100;
                updateAnalysisProgress(progress);
            }
        }

        /**
         * 📋 DISPLAY RECOMMENDATIONS
         */
        function displayRecommendations(recommendations) {
            const container = $('#recommendationsContainer');
            container.empty();

            if (recommendations.length === 0) {
                container.html(`
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                        <p>No transfer recommendations at this time. Network is optimally balanced!</p>
                    </div>
                `);
                return;
            }

            recommendations.forEach((rec, index) => {
                const priorityClass = `priority-${rec.priority_level.toLowerCase()}`;
                const confidenceColor = rec.decision_breakdown.confidence_level >= 0.8 ? 'text-success' : 
                                      rec.decision_breakdown.confidence_level >= 0.6 ? 'text-warning' : 'text-danger';

                const html = `
                    <div class="recommendation-item ${priorityClass}" id="rec-${index}">
                        <div class="row">
                            <div class="col-md-8">
                                <h5>
                                    <i class="fas fa-arrow-right"></i> 
                                    ${rec.source_outlet.outlet_name} → ${rec.target_outlet.outlet_name}
                                    <span class="badge badge-${getPriorityBadgeClass(rec.priority_level)} ml-2">${rec.priority_level}</span>
                                </h5>
                                <p class="mb-2">
                                    <strong>Products:</strong> ${rec.logistics_summary.total_items} items 
                                    | <strong>Weight:</strong> ${rec.logistics_summary.total_weight_kg}kg
                                    | <strong>Value:</strong> $${rec.financial_summary.total_value.toFixed(2)}
                                </p>
                                <div class="row">
                                    <div class="col-sm-6">
                                        <small><strong>Shipping Cost:</strong> $${rec.financial_summary.shipping_cost.toFixed(2)} (${rec.decision_breakdown.cost_efficiency.toFixed(1)}% efficient)</small>
                                    </div>
                                    <div class="col-sm-6">
                                        <small><strong>Profit Margin:</strong> ${rec.decision_breakdown.profit_margin.toFixed(1)}% | <strong>ROI:</strong> ${rec.decision_breakdown.roi_percentage.toFixed(1)}%</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-right">
                                <div class="mb-2">
                                    <strong class="${confidenceColor}">Confidence: ${(rec.decision_breakdown.confidence_level * 100).toFixed(1)}%</strong>
                                </div>
                                <div class="confidence-meter mb-2">
                                    <div class="confidence-fill" style="width: ${rec.decision_breakdown.confidence_level * 100}%"></div>
                                </div>
                                <button class="btn btn-sm btn-turbo" onclick="viewDecisionBreakdown(${index})">
                                    <i class="fas fa-search"></i> View Details
                                </button>
                                <button class="btn btn-sm btn-success-turbo ml-2" onclick="executeTransfer(${index})">
                                    <i class="fas fa-check"></i> Execute
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                container.append(html);
            });
        }

        /**
         * 📊 UPDATE METRICS DISPLAY
         */
        function updateMetrics(summary) {
            if (!summary) return;

            systemMetrics = {
                activeTransfers: summary.total_recommendations || 0,
                totalValue: summary.financial_overview?.total_transfer_value || 0,
                shippingCost: summary.financial_overview?.total_shipping_cost || 0,
                profitMargin: summary.financial_overview?.avg_roi_percentage || 0,
                totalWeight: summary.logistics_overview?.total_weight_kg || 0,
                totalDistance: 0 // Will be updated from route optimization
            };

            $('#activeTransfers').text(systemMetrics.activeTransfers);
            $('#totalValue').text('$' + systemMetrics.totalValue.toFixed(0));
            $('#shippingCost').text('$' + systemMetrics.shippingCost.toFixed(0));
            $('#profitMargin').text(systemMetrics.profitMargin.toFixed(1) + '%');
            $('#totalWeight').text(systemMetrics.totalWeight.toFixed(1) + 'kg');
            $('#totalDistance').text(systemMetrics.totalDistance.toFixed(1) + 'km');

            // Update AI confidence
            const aiConfidence = summary.confidence_metrics?.avg_confidence || 0;
            $('#aiConfidence').text((aiConfidence * 100).toFixed(1) + '%');
            $('#overallConfidence').text((aiConfidence * 100).toFixed(1) + '%');
            $('#confidenceFill').css('width', (aiConfidence * 100) + '%');
        }

        /**
         * 🗺️ UPDATE ROUTE MAP WITH RECOMMENDATIONS
         */
        function updateRouteMap(recommendations) {
            // Clear existing route lines
            map.eachLayer(layer => {
                if (layer instanceof L.Polyline) {
                    map.removeLayer(layer);
                }
            });

            let totalDistance = 0;

            // Draw routes for each recommendation
            recommendations.forEach((rec, index) => {
                const source = rec.source_outlet;
                const target = rec.target_outlet;

                if (source.latitude && target.latitude) {
                    // Draw route line
                    const route = L.polyline([
                        [source.latitude, source.longitude],
                        [target.latitude, target.longitude]
                    ], {
                        color: getPriorityColor(rec.priority_level),
                        weight: 4,
                        opacity: 0.7
                    }).addTo(map);

                    // Add route popup
                    const distance = rec.route_optimization?.total_distance_km || 0;
                    totalDistance += distance;

                    route.bindPopup(`
                        <strong>Route ${index + 1}</strong><br>
                        ${source.outlet_name} → ${target.outlet_name}<br>
                        Distance: ${distance.toFixed(1)}km<br>
                        Priority: ${rec.priority_level}<br>
                        Confidence: ${(rec.decision_breakdown.confidence_level * 100).toFixed(1)}%
                    `);
                }
            });

            // Update total distance metric
            systemMetrics.totalDistance = totalDistance;
            $('#totalDistance').text(totalDistance.toFixed(1) + 'km');
        }

        /**
         * 🔍 VIEW DECISION BREAKDOWN
         */
        function viewDecisionBreakdown(index) {
            const rec = currentRecommendations[index];
            if (!rec) return;

            const modal = `
                <div class="modal fade" id="decisionModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-microscope"></i> Decision Breakdown</h5>
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                            </div>
                            <div class="modal-body">
                                <h6>Transfer: ${rec.source_outlet.outlet_name} → ${rec.target_outlet.outlet_name}</h6>
                                
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <strong>Financial Analysis:</strong>
                                        <ul class="list-unstyled ml-3">
                                            <li>Total Value: $${rec.financial_summary.total_value.toFixed(2)}</li>
                                            <li>Shipping Cost: $${rec.financial_summary.shipping_cost.toFixed(2)}</li>
                                            <li>Profit Margin: ${rec.decision_breakdown.profit_margin.toFixed(1)}%</li>
                                            <li>ROI: ${rec.decision_breakdown.roi_percentage.toFixed(1)}%</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Decision Factors:</strong>
                                        <ul class="list-unstyled ml-3">
                                            <li>Confidence: ${(rec.decision_breakdown.confidence_level * 100).toFixed(1)}%</li>
                                            <li>Cost Efficiency: ${(rec.decision_breakdown.cost_efficiency * 100).toFixed(1)}%</li>
                                            <li>Pack Compliance: ${(rec.decision_breakdown.pack_compliance_rate * 100).toFixed(1)}%</li>
                                            <li>Priority: ${rec.priority_level}</li>
                                        </ul>
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <strong>Influence Factors:</strong>
                                    <div id="modalInfluenceFactors" class="mt-2">
                                        ${generateInfluenceFactorsHTML(rec.influence_factors)}
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <strong>Products (${rec.products.length}):</strong>
                                    <div class="table-responsive mt-2">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Product</th>
                                                    <th>Qty</th>
                                                    <th>Pack Size</th>
                                                    <th>Weight</th>
                                                    <th>Value</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${rec.products.map(p => `
                                                    <tr>
                                                        <td>${p.product_name || 'Unknown Product'}</td>
                                                        <td>${p.pack_compliant_qty || p.suggested_qty}</td>
                                                        <td>${p.pack_rules?.pack_size || 1}</td>
                                                        <td>${p.weight_per_unit || 0}g</td>
                                                        <td>$${p.transfer_value?.toFixed(2) || '0.00'}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-turbo" onclick="exportDecisionData(${index})">
                                    <i class="fas fa-download"></i> Export Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            $('body').append(modal);
            $('#decisionModal').modal('show');
            $('#decisionModal').on('hidden.bs.modal', function () {
                $(this).remove();
            });
        }

        /**
         * 🔍 DISPLAY DECISION LOG
         */
        function displayDecisionLog(logEntries) {
            const logContainer = $('#decisionLog');
            
            if (logEntries && logEntries.length > 0) {
                decisionLogEntries = logEntries;
                
                const logHTML = logEntries.slice(-20).map(entry => {
                    const timestamp = new Date(entry.timestamp).toLocaleTimeString();
                    return `[${timestamp}] ${entry.decision_type}: ${entry.message}`;
                }).join('\n');
                
                logContainer.text(logHTML);
                logContainer.scrollTop(logContainer[0].scrollHeight);
            }
        }

        /**
         * 📊 LOG DECISION (CLIENT SIDE)
         */
        function logDecision(type, message, data = {}) {
            const entry = {
                timestamp: new Date().toISOString(),
                decision_type: type,
                message: message,
                data: data
            };
            
            decisionLogEntries.push(entry);
            
            if (isDebugMode) {
                const logContainer = $('#decisionLog');
                const timestamp = new Date().toLocaleTimeString();
                logContainer.append(`\n[${timestamp}] ${type}: ${message}`);
                logContainer.scrollTop(logContainer[0].scrollHeight);
            }
            
            console.log(`🧠 DECISION [${type}]: ${message}`, data);
        }

        /**
         * 🎛️ TOGGLE DEBUG MODE
         */
        function toggleDebugMode() {
            isDebugMode = !isDebugMode;
            
            if (isDebugMode) {
                $('#debugPanel').show();
                $('#debugToggleText').text('Disable Debug Mode');
                showToast('🔍 Debug mode enabled', 'info');
            } else {
                $('#debugPanel').hide();
                $('#debugToggleText').text('Enable Debug Mode');
                showToast('Debug mode disabled', 'info');
            }
        }

        /**
         * 🗺️ OPTIMIZE ROUTES
         */
        async function optimizeRoutes() {
            if (currentRecommendations.length === 0) {
                showToast('No recommendations to optimize. Run analysis first.', 'warning');
                return;
            }

            const strategy = $('#routeStrategy').val();
            const avoidTraffic = $('#avoidTraffic').is(':checked');
            const multipleDeliveries = $('#multipleDeliveries').is(':checked');

            showToast('🗺️ Optimizing delivery routes...', 'info');

            // Simulate route optimization
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Update route display
            updateRouteMap(currentRecommendations);
            
            showToast(`✅ Routes optimized using ${strategy} strategy!`, 'success');
            logDecision('ROUTE_OPTIMIZATION', `Routes optimized with ${strategy} strategy`);
        }

        /**
         * 💰 ANALYZE COSTS
         */
        async function analyzeCosts() {
            const maxShippingCost = parseInt($('#maxShippingCost').val());
            const minROI = parseInt($('#minROI').val());

            showToast('💰 Analyzing cost optimization...', 'info');

            // Simulate cost analysis
            await new Promise(resolve => setTimeout(resolve, 1500));

            // Filter recommendations by cost criteria
            if (currentRecommendations.length > 0) {
                const filteredRecs = currentRecommendations.filter(rec => {
                    const costPercentage = (rec.financial_summary.shipping_cost / rec.financial_summary.total_value) * 100;
                    const roi = rec.decision_breakdown.roi_percentage;
                    return costPercentage <= maxShippingCost && roi >= minROI;
                });

                displayRecommendations(filteredRecs);
                showToast(`💰 Cost analysis complete. ${filteredRecs.length} cost-efficient transfers identified.`, 'success');
            } else {
                showToast('No recommendations available for cost analysis.', 'warning');
            }
        }

        /**
         * ✅ EXECUTE TRANSFER
         */
        async function executeTransfer(index) {
            const rec = currentRecommendations[index];
            if (!rec) return;

            if (!confirm(`Execute transfer from ${rec.source_outlet.outlet_name} to ${rec.target_outlet.outlet_name}?`)) {
                return;
            }

            showToast('⚡ Executing transfer...', 'info');

            try {
                // Simulate transfer execution
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Mark as executed
                $(`#rec-${index}`).addClass('bg-success text-white').find('.btn').prop('disabled', true);
                
                showToast(`✅ Transfer executed successfully!`, 'success');
                logDecision('TRANSFER_EXECUTED', `Transfer executed: ${rec.source_outlet.outlet_name} → ${rec.target_outlet.outlet_name}`);
                
            } catch (error) {
                showToast(`❌ Transfer execution failed: ${error.message}`, 'error');
            }
        }

        /**
         * 📊 UPDATE INFLUENCE FACTORS DISPLAY
         */
        function loadInfluenceFactors() {
            const factors = {
                'Stock Levels': 0.25,
                'Pack Compliance': 0.20,
                'Shipping Costs': 0.18,
                'Profit Margins': 0.15,
                'Route Efficiency': 0.12,
                'Demand Forecast': 0.10
            };

            updateInfluenceFactorsDisplay(factors);
        }

        function updateInfluenceFactors() {
            // Simulate dynamic factor updates during analysis
            const factors = {
                'Stock Levels': Math.random() * 0.3 + 0.2,
                'Pack Compliance': Math.random() * 0.25 + 0.15,
                'Shipping Costs': Math.random() * 0.22 + 0.12,
                'Profit Margins': Math.random() * 0.18 + 0.10,
                'Route Efficiency': Math.random() * 0.15 + 0.08,
                'Demand Forecast': Math.random() * 0.12 + 0.05
            };

            updateInfluenceFactorsDisplay(factors);
        }

        function updateInfluenceFactorsDisplay(factors) {
            const container = $('#influenceFactors');
            container.empty();

            Object.entries(factors).forEach(([name, value]) => {
                const percentage = (value * 100).toFixed(1);
                const html = `
                    <div class="influence-factor">
                        <span>${name}</span>
                        <div class="factor-bar">
                            <div class="factor-fill" style="width: ${percentage}%"></div>
                        </div>
                        <small>${percentage}%</small>
                    </div>
                `;
                container.append(html);
            });
        }

        function generateInfluenceFactorsHTML(factors) {
            if (!factors) return '<p class="text-muted">No influence factor data available</p>';
            
            return Object.entries(factors).map(([key, value]) => {
                const percentage = (value * 100).toFixed(1);
                return `
                    <div class="influence-factor">
                        <span>${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                        <div class="factor-bar">
                            <div class="factor-fill" style="width: ${percentage}%"></div>
                        </div>
                        <small>${percentage}%</small>
                    </div>
                `;
            }).join('');
        }

        /**
         * 🎨 UTILITY FUNCTIONS
         */
        function updateLastUpdateTime() {
            $('#lastUpdate').text(new Date().toLocaleTimeString());
        }

        function updateSystemHealth() {
            // Simulate system health check
            const health = 85 + Math.random() * 15; // 85-100%
            $('#systemHealth').css('width', health + '%');
            
            if (health >= 95) {
                $('#systemHealth').removeClass('bg-warning bg-danger').addClass('bg-success');
            } else if (health >= 80) {
                $('#systemHealth').removeClass('bg-success bg-danger').addClass('bg-warning');
            } else {
                $('#systemHealth').removeClass('bg-success bg-warning').addClass('bg-danger');
            }
        }

        function updateConfidenceDisplay() {
            const value = $('#confidenceThreshold').val();
            $('#confidenceValue').text(value + '%');
        }

        function updateShippingCostDisplay() {
            const value = $('#maxShippingCost').val();
            $('#shippingCostValue').text(value + '%');
        }

        function updateROIDisplay() {
            const value = $('#minROI').val();
            $('#roiValue').text(value + '%');
        }

        function updateAnalysisProgress(percentage) {
            // Could add progress bar if needed
            console.log(`Analysis progress: ${percentage}%`);
        }

        function getPriorityColor(priority) {
            switch(priority) {
                case 'HIGH': return '#e74c3c';
                case 'MEDIUM': return '#f39c12';
                case 'LOW': return '#27ae60';
                default: return '#3498db';
            }
        }

        function getPriorityBadgeClass(priority) {
            switch(priority) {
                case 'HIGH': return 'danger';
                case 'MEDIUM': return 'warning';
                case 'LOW': return 'success';
                default: return 'secondary';
            }
        }

        /**
         * 🎉 TOAST NOTIFICATION SYSTEM
         */
        function showToast(message, type = 'info') {
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };

            const colors = {
                success: 'bg-success',
                error: 'bg-danger',
                warning: 'bg-warning',
                info: 'bg-info'
            };

            const toastId = 'toast-' + Date.now();
            const toast = `
                <div class="toast ${colors[type]} text-white" id="${toastId}" role="alert">
                    <div class="toast-body">
                        <i class="${icons[type]} mr-2"></i>
                        ${message}
                        <button type="button" class="ml-2 mb-1 close text-white" onclick="$('#${toastId}').toast('hide')">
                            <span>&times;</span>
                        </button>
                    </div>
                </div>
            `;

            $('#toastContainer').append(toast);
            $(`#${toastId}`).toast({ delay: 5000 }).toast('show');
            
            // Auto remove after hiding
            $(`#${toastId}`).on('hidden.bs.toast', function() {
                $(this).remove();
            });
        }

        /**
         * 📥 EXPORT FUNCTIONS
         */
        function exportDebugLog() {
            if (decisionLogEntries.length === 0) {
                showToast('No debug log data to export', 'warning');
                return;
            }

            const data = JSON.stringify({
                session_id: 'DASHBOARD_' + Date.now(),
                timestamp: new Date().toISOString(),
                decision_log: decisionLogEntries,
                system_metrics: systemMetrics,
                recommendations_count: currentRecommendations.length
            }, null, 2);

            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `turbo-transfer-debug-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showToast('📥 Debug log exported successfully!', 'success');
        }

        function exportDecisionData(index) {
            const rec = currentRecommendations[index];
            if (!rec) return;

            const data = JSON.stringify(rec, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `transfer-decision-${rec.transfer_id}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showToast('📥 Decision data exported!', 'success');
            $('#decisionModal').modal('hide');
        }
    </script>

            </div>
        </div>
    </div>
</div>
<!-- END CIS STANDARD CONTAINER -->

</body>
</html>
